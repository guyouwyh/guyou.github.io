<!-- build time:Sat Apr 23 2022 10:45:20 GMT+0800 (China Standard Time) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><link rel="mask-icon" href="/images/logo.svg" color=""><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="努力走,走到灯火通明" href="https://guyouwyh.github.io/guyouwyh/rss.xml"><link rel="alternate" type="application/atom+xml" title="努力走,走到灯火通明" href="https://guyouwyh.github.io/guyouwyh/atom.xml"><link rel="alternate" type="application/json" title="努力走,走到灯火通明" href="https://guyouwyh.github.io/guyouwyh/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="分布式,Redis,非关系型数据库"><link rel="canonical" href="https://guyouwyh.github.io/guyouwyh/2021/10/21/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/redis/"><title>Redis笔记 - Redis - 数据库 | GuYou = 努力走,走到灯火通明</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Redis笔记</h1><div class="meta"><span class="item" title="创建时间：2021-10-21 21:07:38"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-10-21T21:07:38+08:00">2021-10-21</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>17k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>15 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">GuYou</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://s2.loli.net/2021/12/15/fqp9bDFPBEIHCz5.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2021/12/15/nQSr6Dxua7pIvlB.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2021/12/15/7E2sYl8uZARyLqh.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2021/12/15/8KdoJ6jO7mLCDUu.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2021/12/15/z4byuMFYqEKQS2O.jpg"></li><li class="item" data-background-image="https://s2.loli.net/2021/12/15/G4jpqX6zghEYZBI.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="item" rel="index" title="分类于 数据库"><span itemprop="name">数据库</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/" itemprop="item" rel="index" title="分类于 Redis"><span itemprop="name">Redis</span></a><meta itemprop="position" content="2"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://guyouwyh.github.io/guyouwyh/2021/10/21/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/redis/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="故犹"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="努力走,走到灯火通明"></span><div class="body md" itemprop="articleBody"><h1 id="redis概述"><a class="anchor" href="#redis概述">#</a> Redis 概述</h1><p><strong>REmote DIctionary Server (Redis) 是一个由 Salvatore Sanfilippo 写的 key-value 存储系统，是跨平台的非关系型数据库。</strong></p><p><strong>Redis 是一个开源的使用 ANSI C 语言编写、遵守 BSD 协议、支持网络、可基于内存、分布式、可选持久性的键值对 (Key-Value) 存储数据库，并提供多种语言的 API。</strong></p><p><strong>Redis 通常被称为数据结构服务器，因为值（value）可以是字符串 (String)、哈希 (Hash)、列表 (list)、集合 (sets) 和有序集合 (sorted sets) 等类型。</strong></p><p>总结：Redis 是一个内存型的数据库缓存中间件</p><blockquote><p>Redis 特点</p></blockquote><ul><li>Redis 是一个高性能 key/value 内存型数据</li><li>Redis 支持丰富的数据类型</li><li>Redis 支持持久化</li><li>Redis 单线程、单进程</li></ul><h1 id="redis下载"><a class="anchor" href="#redis下载">#</a> Redis 下载</h1><blockquote><p>下载软件包</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">wget</span> https://download.redis.io/releases/redis-4.0.10.tar.gz</pre></td></tr></table></figure><blockquote><p>解压</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">tar</span> zxvf redis-4.0.10.tar.gz</pre></td></tr></table></figure><blockquote><p>安装 GCC</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>yum <span class="token function">install</span> -y gcc</pre></td></tr></table></figure><blockquote><p>安装</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">cd</span>  redis-4.0.10</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">make</span> <span class="token assign-left variable">MALLOC</span><span class="token operator">=</span>libc</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">make</span> <span class="token function">install</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/redis</pre></td></tr></table></figure><h1 id="redis-命令"><a class="anchor" href="#redis-命令">#</a> Redis 命令</h1><p>Redis 命令用于在 redis 服务上执行操作。</p><p>要在 redis 服务上执行命令需要一个 redis 客户端。Redis 客户端在我们之前下载的的 redis 的安装包中。</p><p>启动服务</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./redis-server</pre></td></tr></table></figure><p>客户端连接服务</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>redis-cli -h <span class="token number">127.0</span>.0.1 -p <span class="token number">6379</span></pre></td></tr></table></figure><p>关闭服务</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>redis-cli -h <span class="token number">127.0</span>.0.1 -p <span class="token number">6379</span> <span class="token function">shutdown</span></pre></td></tr></table></figure><blockquote><h2 id="redis启动细节"><a class="anchor" href="#redis启动细节">#</a> redis 启动细节</h2></blockquote><p>注意：直接使用 <code>./redis-server</code> 方式启动使用的是 redis-server 这个 shell 脚本中的默认配置</p><p>默认在 redis 安装完成之后在安装目录没有任何配置文件，需要在源码目录中复制配置文件到安装目录</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">cp</span> redis.conf /usr/redis/ <span class="token comment">#将 redis 源码中配置文件拷贝一份到 redis 目录中</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">cd</span> /usr/redis/bin <span class="token comment">#进入 redis 的 bin 目录</span></pre></td></tr><tr><td data-num="3"></td><td><pre>./redis-server <span class="token punctuation">..</span>/redis.conf  <span class="token comment">#通过配置文件启动 redis</span></pre></td></tr></table></figure><blockquote><h2 id="修改启动端口"><a class="anchor" href="#修改启动端口">#</a> 修改启动端口</h2></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vim</span> /redis.conf <span class="token comment">#编辑配置文件</span></pre></td></tr><tr><td data-num="2"></td><td><pre>找到端口port 修改即可</pre></td></tr></table></figure><blockquote><p>修改密码和后台启动</p></blockquote><p><img data-src="http://cdn.guyouwyh.cool/image-20210814221021974.png" alt="image-20210814221021974"></p><p><img data-src="http://cdn.guyouwyh.cool/image-20210814221053311.png" alt="image-20210814221053311"></p><p><img data-src="http://cdn.guyouwyh.cool/image-20210814221224209.png" alt="image-20210814221224209"></p><blockquote><h2 id="redis中库的概念"><a class="anchor" href="#redis中库的概念">#</a> redis 中库的概念</h2></blockquote><p>库:database 用来存放数据一个基本单元 一个库可以存放 key-value 键值对，redis 中每一个库都有一个唯一名称，编号从 0 开始，默认库的个数：16 个库 库的编号：0-15 默认使用 0 号库</p><blockquote><h2 id="切换库"><a class="anchor" href="#切换库">#</a> 切换库</h2></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">select</span> number <span class="token comment">#number 从 0-15</span></pre></td></tr></table></figure><blockquote><h2 id="清空库"><a class="anchor" href="#清空库">#</a> 清空库</h2></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>flushDB <span class="token comment">#清空当前库</span></pre></td></tr><tr><td data-num="2"></td><td><pre>flushALL <span class="token comment">#清空所有库</span></pre></td></tr></table></figure><h1 id="redis的基本数据类型"><a class="anchor" href="#redis的基本数据类型">#</a> Redis 的基本数据类型</h1><h2 id="键key"><a class="anchor" href="#键key">#</a> 键 (key)</h2><ul><li><code>DEL key</code> : 删除键值，可以删除多个键值，空格隔开</li><li><code>EXIST key</code> : 检验是否存在 key</li><li><code>EXPIRE key seconds</code> : 为 key 设置生存时间，当 key 的生存时间为 0, 就会自动删除，以秒为单位</li><li><code>keys *</code> : 查询所有 key<ul><li><code>*</code> : 匹配 0 个或多个字符</li><li><code>?</code> : 匹配一个字符</li><li><code>[]</code> : 匹配一个字符，比如 [ae], 匹配字符只能是 a 或者是 e</li></ul></li><li><code>get key</code> : 获取 key 的值</li></ul><p>注意：默认情况下启动，如果存入的是中文会以编码形式呈现，如果需要获取到存入的值，连接服务的时候要加上 <code>--raw</code> 参数</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./redis-cli -h localhost -p <span class="token number">7777</span> --raw</pre></td></tr></table></figure><ul><li><p><code>move key db</code> ：将一个键移动到另一个库</p></li><li><p><code>ttl key</code> : 查看剩余时间，返回秒，如果返回 - 1, 说明是永久数据，返回 - 2 说明不存在数据</p></li><li><p><code>pttl key</code> : 查看剩余时间，返回毫秒</p></li><li><p><code>randomkey</code> : 随机返回一个 key</p></li><li><p><code>rename key newkey</code> : 修改 key 的值，但是值不变</p></li><li><p><code>type</code> : 判断 key 所对应值的类型</p><ul><li>返回值<ul><li>none (key 不存在)</li><li>string (字符串)</li><li>list (列表)</li><li>set (集合)</li><li>zset (有序集)</li><li>hash (哈希表)</li></ul></li></ul></li></ul><h2 id="字符串string"><a class="anchor" href="#字符串string">#</a> 字符串 (String)</h2><blockquote><h2 id="常用命令"><a class="anchor" href="#常用命令">#</a> 常用命令</h2></blockquote><table><thead><tr><th>set</th><th>设置一个 key/value</th></tr></thead><tbody><tr><td>get</td><td>根据 key 获取对应的 value</td></tr><tr><td>mset</td><td>一次设置多个 key/value</td></tr><tr><td>mget</td><td>一次获取多个 key 的 value</td></tr><tr><td>getset</td><td>获取原始 key 的值，同时设置新值</td></tr><tr><td>strlen</td><td>获取对应 key 存储 value 的长度</td></tr><tr><td>append</td><td>为对应的 key 的 value 追加内容</td></tr><tr><td>getrange 索引从 0 开始</td><td>截取 value 内容</td></tr><tr><td>setex</td><td>设置一个 key 存活的有效期 (秒)</td></tr><tr><td>psetex</td><td>设置一个 key 存活的有效期 (毫秒)</td></tr><tr><td>setnx</td><td>存在不做任何操作，不存在添加</td></tr><tr><td>msetnx (只要有一个存在不做任何处理)</td><td>可以设置多个 key, 只有一个存在都不保存</td></tr><tr><td>decr</td><td>进行数值类型 - 1 的操作</td></tr><tr><td>decrby</td><td>根据提供的数据进行减法操作</td></tr><tr><td>incr</td><td>进行数值类型的 + 1 操作</td></tr><tr><td>incrby</td><td>根据提供的数据进行加法操作</td></tr><tr><td>incrbyfloat</td><td>根据提供的数据加入浮点数</td></tr></tbody></table><h2 id="哈希hash"><a class="anchor" href="#哈希hash">#</a> 哈希 (Hash)</h2><p><img data-src="http://cdn.guyouwyh.cool/image-20210814203051332.png" alt="image-20210814203051332"></p><table><thead><tr><th style="text-align:left">命令</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">hset</td><td style="text-align:left">设置一个 key/value 对</td></tr><tr><td style="text-align:left">hget</td><td style="text-align:left">获得一个 key 对应的 value</td></tr><tr><td style="text-align:left">hgetall</td><td style="text-align:left">获取所有的 key/value 对</td></tr><tr><td style="text-align:left">hdel</td><td style="text-align:left">删除某一个 key/value 对</td></tr><tr><td style="text-align:left">hexists</td><td style="text-align:left">判断一个 key 是否存在</td></tr><tr><td style="text-align:left">hkeys</td><td style="text-align:left">获得所有的 key</td></tr><tr><td style="text-align:left">hvals</td><td style="text-align:left">获得所有的 value</td></tr><tr><td style="text-align:left">hmset</td><td style="text-align:left">设置多个 key/value</td></tr><tr><td style="text-align:left">hmget</td><td style="text-align:left">获得多个 key 的 value</td></tr><tr><td style="text-align:left">hsetnx</td><td style="text-align:left">设置一个不存在的 key 的值</td></tr><tr><td style="text-align:left">hincrby</td><td style="text-align:left">为 value 进行加法运算</td></tr><tr><td style="text-align:left">hincrbyfloat</td><td style="text-align:left">为 value 加入浮点值</td></tr></tbody></table><h2 id="列表list"><a class="anchor" href="#列表list">#</a> 列表 (List)</h2><table><thead><tr><th style="text-align:left">命令</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">lpush</td><td style="text-align:left">将某个值加入到一个 key 列表头部</td></tr><tr><td style="text-align:left">lpushx</td><td style="text-align:left">同 lpush, 但是必须保证这个 key 存在</td></tr><tr><td style="text-align:left">rpush</td><td style="text-align:left">将某个值加入到一个 key 列表末尾</td></tr><tr><td style="text-align:left">rpushx</td><td style="text-align:left">同 rpush, 但是必须要保证这个 key 存在</td></tr><tr><td style="text-align:left">lpop</td><td style="text-align:left">返回和移除列表的第一个元素</td></tr><tr><td style="text-align:left">rpop</td><td style="text-align:left">返回和移除列表的第一个元素 (从右边开始)</td></tr><tr><td style="text-align:left">lrange 0 -1</td><td style="text-align:left">获取某一个下表区间内的元素</td></tr><tr><td style="text-align:left">llen</td><td style="text-align:left">获取列表元素个数</td></tr><tr><td style="text-align:left">lset</td><td style="text-align:left">设置某一个指定索引的值 (必须存在)</td></tr><tr><td style="text-align:left">lindex</td><td style="text-align:left">获取某一个指定索引位置的元素</td></tr><tr><td style="text-align:left">lrem</td><td style="text-align:left">删除重复元素</td></tr><tr><td style="text-align:left">ltrim</td><td style="text-align:left">保留列表中特定区间内的元素</td></tr><tr><td style="text-align:left">linsert</td><td style="text-align:left">在某一个元素之前，之后插入新元素</td></tr></tbody></table><h2 id="集合set"><a class="anchor" href="#集合set">#</a> 集合 (Set)</h2><p>特点:set 集合 set 集合 元素无序，不可用重复</p><table><thead><tr><th style="text-align:left">命令</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td style="text-align:left">smembers</td><td style="text-align:left">显示集合中所有元素，无序</td></tr><tr><td style="text-align:left">sadd</td><td style="text-align:left">为集合添加元素</td></tr><tr><td style="text-align:left">scard</td><td style="text-align:left">返回集合中元素的个数</td></tr><tr><td style="text-align:left">spop</td><td style="text-align:left">随机返回一个元素 并将元素在集合中删除</td></tr><tr><td style="text-align:left">smove</td><td style="text-align:left">从一个集合向另一个集合移动元素</td></tr><tr><td style="text-align:left">srem</td><td style="text-align:left">从集合中删除一个元素</td></tr><tr><td style="text-align:left">sismember</td><td style="text-align:left">判断一个集合中是否含有这个元素</td></tr><tr><td style="text-align:left">srandmember</td><td style="text-align:left">随机返回元素</td></tr><tr><td style="text-align:left">sdiff</td><td style="text-align:left">去掉第一个集合中其他元素含有的相同元素</td></tr><tr><td style="text-align:left">sinter</td><td style="text-align:left">去交集</td></tr><tr><td style="text-align:left">sunion</td><td style="text-align:left">求合集</td></tr></tbody></table><h2 id="可排序集合zset"><a class="anchor" href="#可排序集合zset">#</a> 可排序集合 (ZSet)</h2><p>特点：可排序的 set 集合 排序 不可重复</p><table><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td>zadd</td><td>添加一个有序集合元素</td></tr><tr><td>zcard</td><td>返回集合的元素个数</td></tr><tr><td>zrange 升序 zrevrange 降序</td><td>返回一个范围内的元素</td></tr><tr><td>zrangebyscore</td><td>按照分数查找一个范围内的元素</td></tr><tr><td>zrank</td><td>返回排名</td></tr><tr><td>zrevrank</td><td>倒序排名</td></tr><tr><td>zscore</td><td>显示某一个元素的分数</td></tr><tr><td>zrem</td><td>移除某一个元素</td></tr><tr><td>zincrby</td><td>给某个特定元素加分</td></tr></tbody></table><h1 id="redis事务"><a class="anchor" href="#redis事务">#</a> Redis 事务</h1><h2 id="事务的概述"><a class="anchor" href="#事务的概述">#</a> 事务的概述</h2><p>Redis 事务可以一次执行多个命令， 并且带有以下三个重要的保证：</p><ul><li>批量操作在发送 EXEC 命令前被放入队列缓存。</li><li>收到 EXEC 命令后进入事务执行，事务中任意命令执行失败，其余的命令依然被执行。</li><li>在事务执行过程，其他客户端提交的命令请求不会插入到事务执行命令序列中。</li></ul><p>一个事务从开始到执行会经历以下三个阶段：</p><ul><li>开始事务。</li><li>命令入队。</li><li>执行事务。</li></ul><p><strong>注意：单个 Redis 命令的执行是原子性的，但 Redis 没有在事务上增加任何维持原子性的机制，所以 Redis 事务的执行并不是原子性的。</strong></p><p><strong>事务可以理解为一个打包的批量执行脚本，但批量指令并非原子化的操作，中间某条指令的失败不会导致前面已做指令的回滚，也不会造成后续的指令不做。</strong></p><h2 id="事务的基本指令"><a class="anchor" href="#事务的基本指令">#</a> 事务的基本指令</h2><table><thead><tr><th style="text-align:left">序号</th><th style="text-align:left">命令及描述</th></tr></thead><tbody><tr><td style="text-align:left">1</td><td style="text-align:left"><span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS9yZWRpcy90cmFuc2FjdGlvbnMtZGlzY2FyZC5odG1s">DISCARD</span> 取消事务，放弃执行事务块内的所有命令。</td></tr><tr><td style="text-align:left">2</td><td style="text-align:left"><span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS9yZWRpcy90cmFuc2FjdGlvbnMtZXhlYy5odG1s">EXEC</span> 执行所有事务块内的命令。</td></tr><tr><td style="text-align:left">3</td><td style="text-align:left"><span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS9yZWRpcy90cmFuc2FjdGlvbnMtbXVsdGkuaHRtbA==">MULTI</span> 标记一个事务块的开始。</td></tr><tr><td style="text-align:left">4</td><td style="text-align:left"><span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS9yZWRpcy90cmFuc2FjdGlvbnMtdW53YXRjaC5odG1s">UNWATCH</span> 取消 WATCH 命令对所有 key 的监视。</td></tr><tr><td style="text-align:left">5</td><td style="text-align:left">[WATCH key <span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS9yZWRpcy90cmFuc2FjdGlvbnMtd2F0Y2guaHRtbA==">key ...]</span> 监视一个 (或多个) key ，如果在事务执行之前这个 (或这些) key 被其他命令所改动，那么事务将被打断。</td></tr></tbody></table><p>设置 key 的失效时间</p><ul><li><code>EXPLRE&lt;key&gt; &lt;ttl&gt;</code> ：用于将键 key 的生存时间设置为 tt1 秒</li><li><code>PEXPIRE&lt;key&gt; &lt;ttl&gt;</code> : 用于将键 key 的生存时间设置为 tt1 毫秒</li><li><code>EXPIREAT &lt;key&gt; &lt;timestamp&gt;</code> : 用于将键 key 的过期时间设置为 timestamp 所指定的秒数时间戳</li><li><code>PEXPIREAP &lt;key&gt; &lt;timestamp&gt;</code> : 用于将键 key 的过期时间设置为 timestamp 所指定的秒数时间戳</li></ul><p><code>TTL</code> : 获取的值为 - 1 说明此 key 没有设置有效期，当值为 - 2 证明过了有效期</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> age <span class="token number">18</span> ex <span class="token number">60</span> //设置60秒后过期</pre></td></tr></table></figure><h1 id="redis中的持久化"><a class="anchor" href="#redis中的持久化">#</a> Redis 中的持久化</h1><blockquote><p>持久化机制</p></blockquote><p>Redis 官方提供了两种不同的持久化方法来将数据存储到硬盘里，分别是:</p><ul><li><code>快照(Snapshot)</code></li></ul><p>保存这一时刻的数据状态</p><ul><li><code>AOF（Append Only File）只追加日志文件</code></li></ul><p>将所有 redis 写命令记录到日志文件中</p><h2 id="快照snapshot"><a class="anchor" href="#快照snapshot">#</a> 快照 (Snapshot)</h2><blockquote><h2 id="特点"><a class="anchor" href="#特点">#</a> 特点</h2></blockquote><p>这种方式可以将某一时刻的所有数据都写入硬盘中，当然这也是 redis 的默认开启持久化方式，保存的文件是以.rdb 形式结尾的文件，因此这种方式也成为 RDB 方式</p><p><img data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gtglxh4nwpj61ao0cu0to02.jpg" alt="image-20210814204956517"></p><blockquote><p>快照生成方式</p></blockquote><ul><li>客户端方式：BGSAVE 和 SAVE 指令</li><li>服务器配置自动触发</li></ul><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 客户端方式之BGSAVE</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span> 客户端可以使用BGSAVE命令创建一个快照,当接收到客户端的BGSAVE命令时,redis会调用fork来创建一个子进程,然后子进程负责将快照写入磁盘中,而父进程则继续处理命令请求</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>  fork当一个进程创建子进程的时候,底层的操作系统会创建该进程的一个副本,在类unix系统中创建子进程的操作会进行优化,在刚刚开始的时候,父进程共享相同内存,知道父进程或子进程对内存进行了写之后,对呗写的内存的共享才会结束服务</pre></td></tr></table></figure><p><img data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gtgm5w0756j61dk0js76302.jpg" alt="image-20210814205807960"></p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 客户端方式之SAVE</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span> 客户端还可以使用SAVE命令来创建一个快照,接收到SAVE命令的redis服务器在快照创建完毕之前将不再响应任何其他的命令</pre></td></tr></table></figure><p><img data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gtgma1s00fj61ey0da75q02.jpg" alt="image-20210814210208233"></p><p>注意：SAVE 命令并不常用，使用 SAVE 命令在快照创建完毕之前，redis 处于阻塞状态，无法对外服务</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 服务器配置方式之满足配置自动触发</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span> 如果用户在redis.conf中设置了save配置选项,redis会在save选项条件满足之后自欧东触发一个BGSAVE命令,如果设置多个save配置选项,当任意一个save配置选项条件满足,redis也会触发一次BGSAVE命令</pre></td></tr></table></figure><p><img data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gtgmnafn49j616a0o8goz02.jpg" alt="image-20210814211451572"></p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 服务器接收客户端shutdown指令</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span> 当redis通过shutdown指令接收到关闭服务器的请求时,会执行一个save命令,阻塞所有客户端,不再执行客户端执行发送的任何命令,并且save命令执行完毕之后关闭服务器</pre></td></tr></table></figure><h2 id="aof"><a class="anchor" href="#aof">#</a> AOF</h2><blockquote><p>特点</p></blockquote><p>这种方式可以将所有客户端执行的写命令记录到日志文件中，AOF 持久化会将被执行的写命令写到 AOF 文件末尾，以此来记录数据发生的变化，因此只要 redis 从头到尾执行一次 AOF 文件所包含的所有写命令，就可以恢复 AOF 文件的记录的数据集</p><p><img data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gtgmobcilej61eo0cimyj02.jpg" alt="image-20210814211551251"></p><blockquote><h2 id="开启aof持久化"><a class="anchor" href="#开启aof持久化">#</a> 开启 AOF 持久化</h2></blockquote><p>在 redis 的默认配置中 AOF 持久化机制是没有开启的，需要在配置中开启</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 开启AOF持久化</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span> 修改 appendonly yes 开启持久化</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token list punctuation">-</span> 修改 appendfilename  "appendonly.aof" 指定生成的文件名称</pre></td></tr></table></figure><blockquote><h2 id="日志追加频率"><a class="anchor" href="#日志追加频率">#</a> 日志追加频率</h2></blockquote><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> always 【谨慎使用】</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span> 说明:每个redis写命令都要同步写入硬盘,严重降低redis速度</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> everysec 【推荐】</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token list punctuation">-</span> 说明:每秒执行一次同步显式的将多个写命令同步到硬盘</pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> no  【不推荐】</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token list punctuation">-</span> 说明:由操作系统决定何时同步</pre></td></tr></table></figure><h2 id="aof文件的重写"><a class="anchor" href="#aof文件的重写">#</a> AOF 文件的重写</h2><h3 id="aof带来的问题"><a class="anchor" href="#aof带来的问题">#</a> AOF 带来的问题</h3><p>AOF 的方式同时也带来了一个问题，持久化文件会变得越来越大，有些指令是多余的，为了压缩 aof 的持久化文件，Redis 提供了 AOF 的重写机制，在一定程度上减小了 AOF 文件的体积</p><h3 id="触发重写方式"><a class="anchor" href="#触发重写方式">#</a> 触发重写方式</h3><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 客户端方式触发重写</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span> 执行BGREWRITEAOF 命令 不会阻塞redis服务</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 服务器配置方式自动触发</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token list punctuation">-</span> 配置 redis.conf中的auto-aof-rewrite-percentage选项</pre></td></tr><tr><td data-num="6"></td><td><pre>如果设置auto-aof-rewrite-percentage值为100和auto-aof-rewrite-min-size 64mb,并且启用AOF持久化时,那么当AOF文件体积大于64M,并且AOF文件的体积比上一次重写之后体积大了至少一倍(100%),就会自动触发,如果重写过于频繁,可以考虑将auto-aof-rewrite-percentage设置为更大</pre></td></tr></table></figure><h3 id="重写原理"><a class="anchor" href="#重写原理">#</a> 重写原理</h3><p>注意：重写 aof 文件的操作，并没有读取旧的 aof 文件，而是将整个内存中的数据库内容用命令的方式重写了一个新的 aof 文件，替换原有的文件这点和快照有点类似</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 重写流程</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span> <span class="token list punctuation">1.</span> redis调用fork,现在有父子两个进程,子进程根据内存中的数据库快照,往临时文件中写入重建数据库状态的命令</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token list punctuation">-</span> <span class="token list punctuation">2.</span> 父进程继续处理client请求,除了把写命令写入到原来的aof文件中.同时把收到的写命令缓存起来。这样就能保证如果子进程重写失败的话并不会出现问题</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token list punctuation">-</span> <span class="token list punctuation">3.</span> 当子进程把快照内容写入已命令的方式写到临时文件中后,子进程发信号通知父进程,然后父进程把缓存的写命令也写入到临时文件</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token list punctuation">-</span> <span class="token list punctuation">4.</span> 现在父进程可以使用临时文件替换捞的aof文件,并重新命名,后面收到的写命令也开始往新的aof文件中追加</pre></td></tr></table></figure><h2 id="持久化总结"><a class="anchor" href="#持久化总结">#</a> 持久化总结</h2><p>两种持久化方案既可以同时使用，又可以单独使用，在某种情况下也可以都不使用，具体使用哪种持久化方案取决于用户的数据和应用决定</p><p>无论使用 AOF 还是快照机制持久化，将数据持久化到硬盘都是有必要的，除了持久化外，用户还应该对持久化的文件进行备份</p><h1 id="springboot整合redis"><a class="anchor" href="#springboot整合redis">#</a> springboot 整合 Redis</h1><hr><p>Spring Boot Data Redis 中提供了 RedisTemplate 和 StringRedisTemplate, 其中 StringRedisTemplate 是 RedisTemplate 的子类，两个方法基本一致，不同之处主要体现在操作的数据类型不同。RedisTemplate 中的两个泛型都是 Object, 意味着存储的 key 和 value 都可以是一个对象，而 StringRedisTemplate 的两个泛型都是 String, 意味着 StringRedisTemplate 的 key 和 value 都只能是字符串。</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> RedisTemplate (Object,object) 自动序列化 自动反序列化</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> StringRedisTemplate（String,String）</span></pre></td></tr></table></figure><p>注意：使用 RedisTemplate 默认是讲对象序列化到 Redis 中，所以放入的对象必须实现序列化接口</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> redisTemplate对象中key和value的序列化都是jdk默认的序列化方案</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 因此需要修改key序列化方案: 使用StringRedisSerializer</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>wyh<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>lettuce<span class="token punctuation">.</span></span><span class="token class-name">LettuceConnectionFactory</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">LettuceConnectionFactory</span> lettuceConnectionFactory<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> redisTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token comment">// 设置键 String 类型序列化</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 设置对象序列化</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token comment">// 设置 HASH key 的序列化</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>lettuceConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>基本使用</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> redisTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">ValueOperations</span> valueOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">User</span> guyou <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token string">"guyou"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        valueOperations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span>guyou<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>绑定 key 值操作</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>guyou</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>guyou<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">User</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span>jupiter<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Test</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>test<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">SpringBootTest</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">BoundValueOperations</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token annotation punctuation">@SpringBootTest</span><span class="token punctuation">(</span>classes <span class="token operator">=</span> <span class="token class-name">DemoApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">DemoApplicationTests</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span>  <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span>  <span class="token class-name">StringRedisTemplate</span> stringRedisTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   <span class="token keyword">public</span>  <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"guyou"</span><span class="token punctuation">,</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// 如果要对一个 key 进行多次操作，可以先绑定这个 key 值，简化操作</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">BoundValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> name <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">boundValueOps</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        name<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"wyh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="opsforvalue"><a class="anchor" href="#opsforvalue">#</a> opsForValue</h2><p>操作 String 类型</p><ul><li>set: 设置键值对</li><li>get: 获取对应键的值</li><li>multiset: 存储多条数据，放入 map</li><li>multiget: 获取多条数据，放入 list</li><li>delete: 删除数据</li></ul><h2 id="opsforhash"><a class="anchor" href="#opsforhash">#</a> opsForHash</h2><p>操作 hash 类型</p><ul><li><p>put：添加 hash 类型</p><ul><li>第一个参数是 key</li><li>第二个参数是 hashkey</li><li>第三个参数是 hash 值</li></ul></li><li><p>get: 获取 hash</p><ul><li>第一个参数是 key</li><li>第二个参数是 hashkey</li></ul></li><li><p>putAll: 添加多条数据</p><ul><li>第一个参数是 key</li><li>第二个参数是一个 map</li></ul></li><li><p>getall: 获取多条数据</p><ul><li>第一个参数是 key</li><li>第二个参数是集合</li></ul></li><li><p>entries: 获取整个数据</p><ul><li>第一个参数是 key</li><li>返回是一个 map 类型</li></ul></li><li><p>delete: 删除数据</p><ul><li>第一个参数是 key</li><li>后面多个参数是要删除的 hashkey</li></ul></li></ul><h2 id="opsforlist"><a class="anchor" href="#opsforlist">#</a> opsForList</h2><p>操作 list</p><ul><li><p>leftPush: 左添加</p><p>两个参数:</p><ul><li>第一个参数是 list 名，</li><li>第二个是要添加的数据值</li></ul><p>三个参数:</p><ul><li>第一个参数是 list 名</li><li>第二个参数是被左添加的数据</li><li>第三个参数是添加的数据，添加到第二个参数左边</li></ul></li><li><p>rightPush: 右添加</p></li><li><p>range: 获取数据</p><ul><li>第一个参数是 list 名</li><li>第二个参数是获取的起始下标</li><li>第三个参数是获取的结束下表</li></ul></li><li><p>size: 获取总条数</p><ul><li>参数为 list 名</li></ul></li><li><p>remove：删除数据</p><ul><li>第一个参数是 list 名</li><li>第二个参数是删除记录的个数</li><li>第三个参数是要删除的值</li></ul></li><li><p>leftPop: 左删除，删除最左边的数据</p></li><li><p>rightPop: 右删除，删除最右边的数据</p></li></ul><h2 id="opsforset"><a class="anchor" href="#opsforset">#</a> opsForSet</h2><p>操作 set</p><ul><li>add: 添加数据<ul><li>第一个参数 set 名</li><li>可变参数，要放入的值</li></ul></li><li>remove: 删除数据<ul><li>可变参数，要删除的数据</li></ul></li></ul><h2 id="opsforzset"><a class="anchor" href="#opsforzset">#</a> opsForZset</h2><p>操作 sorted set</p><ul><li><p>add：添加</p><ul><li>第一个参数是 key</li><li>第二个参数是 value</li><li>第三个参数是 score</li></ul></li><li><p>range：获取数据</p></li></ul><h2 id="获取所有的key"><a class="anchor" href="#获取所有的key">#</a> 获取所有的 key</h2><p><code>redisTemplate.keys(&quot;*&quot;)</code> :</p><h3 id="设置失效时间"><a class="anchor" href="#设置失效时间">#</a> 设置失效时间</h3><ul><li><p><code>set(&quot;键&quot;,&quot;值&quot;,&quot;失效时间&quot;,&quot;单位&quot;)</code></p></li><li><p><code>expire(&quot;键&quot;,&quot;失效时间&quot;)</code></p></li></ul><h1 id="分布式缓存"><a class="anchor" href="#分布式缓存">#</a> 分布式缓存</h1><h2 id="概念"><a class="anchor" href="#概念">#</a> 概念</h2><blockquote><h2 id="什么是缓存cache"><a class="anchor" href="#什么是缓存cache">#</a> 什么是缓存？(Cache)</h2></blockquote><p>定义：就是计算机内存中一段数据</p><blockquote><h2 id="内存中数据的特点"><a class="anchor" href="#内存中数据的特点">#</a> 内存中数据的特点</h2></blockquote><ul><li>读写快</li><li>断电立即失效</li></ul><blockquote><h2 id="缓存解决的问题"><a class="anchor" href="#缓存解决的问题">#</a> 缓存解决的问题</h2></blockquote><ul><li>提高网站吞吐量</li><li>提高网站运行效率</li><li>缓存的存在是用来减轻数据库访问压力</li></ul><p>注意：缓存一定是数据库中数据极少发生修改，更多用于查询这种情况</p><blockquote><h2 id="本地缓存和分布式缓存的区别"><a class="anchor" href="#本地缓存和分布式缓存的区别">#</a> 本地缓存和分布式缓存的区别</h2></blockquote><p>本地缓存：存在应用服务器内存中数据称之为本地缓存</p><p>分布式缓存：春初在当前应用服务器内存之外数据成为分布式缓存</p><p>集群：将同一种服务的多个节点放在一起共同对系统提供服务的过程称之为集群</p><p>分布式：有多个不同服务集群共同对系统提供服务这个系统称之为分布式系统</p><h2 id="通过整合mybatis实现分布式缓存"><a class="anchor" href="#通过整合mybatis实现分布式缓存">#</a> 通过整合 mybatis 实现分布式缓存</h2><blockquote><p>propties 文件</p></blockquote><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">server.port</span><span class="token punctuation">=</span><span class="token attr-value">8081</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#redis</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token attr-value">guyouwyh.cool</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token attr-name">spring.redis.port</span><span class="token punctuation">=</span><span class="token attr-value">7777</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token attr-name">spring.redis.database</span><span class="token punctuation">=</span><span class="token attr-value">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token attr-name">spring.redis.password</span><span class="token punctuation">=</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token attr-name">spring.datasource.type</span><span class="token punctuation">=</span><span class="token attr-value">com.alibaba.druid.pool.DruidDataSource</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token attr-name">spring.datasource.username</span><span class="token punctuation">=</span><span class="token attr-value">root</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token attr-name">spring.datasource.driver-class-name</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.cj.jdbc.Driver</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token attr-name">spring.datasource.password</span><span class="token punctuation">=</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token attr-name">spring.datasource.url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://localhost:3306/redis?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token attr-name">mybatis.mapper-locations</span><span class="token punctuation">=</span><span class="token attr-value">classpath:mapper/*.xml</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token attr-name">mybatis.type-aliases-package</span><span class="token punctuation">=</span><span class="token attr-value">com.wyh.pojo</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">#日志</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token attr-name">logging.level.com.guyou.mapper</span><span class="token punctuation">=</span><span class="token attr-value">debug</span></pre></td></tr></table></figure><blockquote><h2 id="usermapperxml文件"><a class="anchor" href="#usermapperxml文件">#</a> UserMapper.xml 文件</h2></blockquote><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">&lt;!-- 下面这两行代码需要自己导入 --></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">mapper</span> <span class="token name">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span class="token punctuation">></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.guyou.mapper.UserMapper<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">&lt;!--</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    需要使用 & lt;cache/> 标签开启二级缓存，type 指定 Cache 的实现类</pre></td></tr><tr><td data-num="9"></td><td><pre>    --></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.guyou.Cache.RedisCache<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>delete</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>removeById<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>        delete from `user` where id=#&#123;id&#125;</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>delete</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getAll<span class="token punctuation">"</span></span> <span class="token attr-name">resultType</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.guyou.pojo.User<span class="token punctuation">"</span></span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>        select * from `user`</pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapper</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><blockquote><p>获取 spring 容器中的 bean 工具类</p></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>guyou<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span></span><span class="token class-name">BeansException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationContext</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ApplicationContextAware</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContextUtils</span> <span class="token keyword">implements</span> <span class="token class-name">ApplicationContextAware</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 在 spring 容器初始化完成之后，拿到容器工厂</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContext<span class="token operator">=</span>applicationContext<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 通过名称获取 bean</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">return</span> applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>RedisCache</p></blockquote><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>guyou<span class="token punctuation">.</span></span><span class="token class-name">Cache</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>guyou<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">ApplicationContextUtils</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">Cache</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RedisTemplate</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span></span><span class="token class-name">StringRedisSerializer</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre> * 实现 Cache 接口</pre></td></tr><tr><td data-num="10"></td><td><pre> */</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     * 参照 PerpetualCache 类，必须声明一个 id</pre></td></tr><tr><td data-num="15"></td><td><pre>     * 构造方法也是必须</pre></td></tr><tr><td data-num="16"></td><td><pre>     * @param id</pre></td></tr><tr><td data-num="17"></td><td><pre>     */</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RedisCache</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token operator">=</span>id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="30"></td><td><pre>     * 当第一次进行查询的时候，会执行的方法，value 是从数据库查询出的内容</pre></td></tr><tr><td data-num="31"></td><td><pre>     * 这里需要用 Redis 进行缓存</pre></td></tr><tr><td data-num="32"></td><td><pre>     * @param key</pre></td></tr><tr><td data-num="33"></td><td><pre>     * @param value</pre></td></tr><tr><td data-num="34"></td><td><pre>     */</pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token function">getRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="41"></td><td><pre>     * 当第二次查询时候，从缓存中拿取数据</pre></td></tr><tr><td data-num="42"></td><td><pre>     * @param key</pre></td></tr><tr><td data-num="43"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="44"></td><td><pre>     */</pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">getRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">removeObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="56"></td><td><pre>     * 当进行增删操作时候，要清空缓存</pre></td></tr><tr><td data-num="57"></td><td><pre>     */</pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token function">getRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="64"></td><td><pre>     * 用来计算缓存数量</pre></td></tr><tr><td data-num="65"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="66"></td><td><pre>     */</pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">getRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="73"></td><td><pre>     * 私有方法，将 RedisTemplate 的 key 和 hash 的 key 进行 String 序列化</pre></td></tr><tr><td data-num="74"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="75"></td><td><pre>     */</pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> <span class="token function">getRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token class-name">RedisTemplate</span> redisTemplate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RedisTemplate</span><span class="token punctuation">)</span> <span class="token class-name">ApplicationContextUtils</span><span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token string">"redisTemplate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>      redisTemplate<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>      redisTemplate<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>      <span class="token keyword">return</span> redisTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><code>注意</code> ：当出现关联查询的时候，需要使用 <code>cache-ref</code> , 将该模块缓存与另一个模块放在一起</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>cache-ref</span> <span class="token attr-name">namespace</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.guyou.mapper.UserMapper<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span> <span class="token comment">&lt;!-- 这里将该模块缓存与 UserMapper 缓存放一起 --></span></pre></td></tr></table></figure><h2 id="缓存优化策略"><a class="anchor" href="#缓存优化策略">#</a> 缓存优化策略</h2><p>对放入 redis 中的 key 进行优化，让 key 的长度不要太长</p><p>使用算法 MD5 对 key 进行加密，生成一个 32 位 16 进制的字符串</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getMd5</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>       <span class="token keyword">return</span>  <span class="token class-name">DigestUtils</span><span class="token punctuation">.</span><span class="token function">md5DigestAsHex</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="面试相关概念"><a class="anchor" href="#面试相关概念">#</a> 面试相关概念</h2><blockquote><h2 id="什么是缓存穿透"><a class="anchor" href="#什么是缓存穿透">#</a> 什么是缓存穿透</h2></blockquote><p>定义：客户端查询了一个数据库中没有的数据库记录，导致这种情况下缓存无法利用</p><p>mybatis 中 cache 解决了缓存穿透：将数据库中没有查询到的结果进行缓存</p><blockquote><h2 id="什么是缓存雪崩"><a class="anchor" href="#什么是缓存雪崩">#</a> 什么是缓存雪崩</h2></blockquote><p>定义：在系统运行的某一时刻，突然系统中的缓存全部失效，恰好在这一时刻引来大量的客户端请求，导致所有缓存无法利用，导致大量请求涌向数据库，数据库阻塞或挂起。</p><p>解决方案:</p><ul><li>缓存永久存储 【不推荐】</li><li>针对不同的业务数据一定要设置不同的超时时间</li></ul><h1 id="主从复制"><a class="anchor" href="#主从复制">#</a> 主从复制</h1><p>主从复制架构仅仅用来解决数据的冗余备份，从节点仅仅用来同步数据，不能写数据</p><p><code>无法解决自动故障转移</code></p><p><img data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gthoaeioq6j61e20i8wf802.jpg" alt="image-20210815185711973"></p><blockquote><p>搭建主从复制</p></blockquote><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 准备三台机器进行如下配置</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span> master</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token list punctuation">-</span> port 8001</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token list punctuation">-</span> bind 0.0.0.0</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token list punctuation">-</span> slave1</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token list punctuation">-</span> port 8002</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token list punctuation">-</span> bind 0.0.0.0</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token list punctuation">-</span> slaveof masterip masterport</pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token list punctuation">-</span> slave2</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token list punctuation">-</span> port 8003</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token list punctuation">-</span> bind 0.0.0.0</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token list punctuation">-</span> slaveof masterip masterport</pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 注意,如果主节点有密码,从节点需要设置masterauth 来指定从节点的密码,才能连接得上</span></pre></td></tr></table></figure><h1 id="哨兵机制"><a class="anchor" href="#哨兵机制">#</a> 哨兵机制</h1><blockquote><p>哨兵 Sentinel 机制</p></blockquote><p>Sentinel 是 Redis 的高可用解决方案：由一个或多个 sentinel 实例组成的 sentinel 系统可以监视任意多个主服务器，以及这些主服务器属下的所有从服务器，并在被监视的主服务器下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器，简单来说哨兵就是带有自动故障转译功能的主从架构。</p><p><code>无法解决单节点并发压力</code></p><p><img data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gthq4zplaxj61gm0dwwgm02.jpg" alt="image-20210815200113222"></p><blockquote><p>建立哨兵</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">mkdir</span> sentinel <span class="token comment">#创建一个哨兵文件夹</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">cd</span> sentinel</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">touch</span> sentinel.conf <span class="token comment">#创建哨兵的配置文件</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">#######################</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># name 是哨兵的名字  ip 是 port 是主机的 ip 和端口号   number 是主机的数量</span></pre></td></tr><tr><td data-num="6"></td><td><pre>sentinel monitor name <span class="token function">ip</span> port number</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">#端口</span></pre></td></tr><tr><td data-num="8"></td><td><pre>port <span class="token number">26379</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#开启远程连接</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">#如果主机设置了密码的话，需要加如下命令，name 为上面 name,password 为主机的密码</span></pre></td></tr><tr><td data-num="12"></td><td><pre>sentinel auth-pass name password</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">#####################</span></pre></td></tr><tr><td data-num="14"></td><td><pre>进入源码目录中,将src下的redis-sentinel复制到redis的bin目录中</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token function">cp</span> redis-sentinel /usr/redis/bin/</pre></td></tr><tr><td data-num="16"></td><td><pre>启动哨兵</pre></td></tr><tr><td data-num="17"></td><td><pre>/usr/redis/bin/redis-sentinel /home/sentinel/sentinel.conf</pre></td></tr></table></figure><blockquote><p>Springboot 集成哨兵</p></blockquote><p>application.properties</p><figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#redis 中密码</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">spring.redis.password</span><span class="token punctuation">=</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># sentinel.conf 中配置的 name</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token attr-name">spring.redis.sentinel.master</span><span class="token punctuation">=</span><span class="token attr-value">mymaster</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#哨兵服务的端口，会自动通过哨兵找到主机</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token attr-name">spring.redis.sentinel.nodes</span><span class="token punctuation">=</span><span class="token attr-value">guyouwyh.cool:26379</span></pre></td></tr></table></figure><h1 id="集群"><a class="anchor" href="#集群">#</a> 集群</h1><p>Redis 在 3.0 之后开始支持 Cluster (集群) 模式，目前 redis 的集群支持节点的自动发现，支持 slave-master 选举和容错，支持在线分片等特性</p><h2 id="集群细节"><a class="anchor" href="#集群细节">#</a> 集群细节</h2><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token list punctuation">-</span> 所有的redis节点彼此互联(ping-pong机制),内部使用二进制协议优化传输速度和带宽</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span> 节点的fail是通过集群中超过半数的节点检测失效时才生效</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token list punctuation">-</span> 客户端与redis节点直连,需要中间proxy层,客户端不需要连接集群所有节点,连接集群中任意一个节点即可</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token list punctuation">-</span> redis-cluster把所有的物理节点映射到【0-16383】slot(槽)上,cluster负责维护node<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>--</span><span class="token punctuation">></span></span>slot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>--</span><span class="token punctuation">></span></span>value</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token list punctuation">-</span> slot会平均分配给节点,Redis集群最大节点数补鞥呢超过16384</pre></td></tr></table></figure><h2 id="集群原理"><a class="anchor" href="#集群原理">#</a> 集群原理</h2><p><img data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gthsv82mr4j61fi0ryjut02.jpg" alt="image-20210815213537991"></p><p>CRC16 算法的特点:</p><ul><li>对集群模式下的所有 key 进行 CRC16 计算，计算结果始终在 0-16383 之间</li><li>对客户端的 key 进行 CRC16 计算时，同一个 key 的计算结果始终一致</li><li>对客户端的不同 key 进行 CRC16 计算时，不同的 key 计算结果有可能一致</li></ul><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 当客户端连接任意一个节点的时候,存入一个key值,CRC16根据key值进行计算,计算出槽数,然后分配到对应槽的节点,存入数据,根据CRC16算法的特点，到时候取key也会到相应的节点去取。</span></pre></td></tr></table></figure><h2 id="集群的搭建"><a class="anchor" href="#集群的搭建">#</a> 集群的搭建</h2><p>判断一个是集群中的节点是否可用，是集群中的所用主节点选举过程，如果半数以上的节点认为当前节点挂掉，那么当前节点就是挂掉了，所以搭建 redis 集群时建议节点最好为奇数，搭建集群至少需要三个主节点，三个从节点，至少需要六个节点</p><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 准备黄金安装ruby以及redis集群依赖</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span> yum install -y ruby rubygems</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token list punctuation">-</span> gem install redis</pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 准备配置文件</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token list punctuation">-</span> bind 0.0.0.0</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token list punctuation">-</span> port 7001</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token list punctuation">-</span> daemonize yes</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token list punctuation">-</span> dbfilename "dump7001.rdb"</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token list punctuation">-</span> masterauth 主机的密码</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token list punctuation">-</span> requirepass 密码</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token list punctuation">-</span> appendonly yes #开启aof</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token list punctuation">-</span> appendfilename "appendonly7001.aof"</pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token list punctuation">-</span> cluster-enabled yes #集群的开启</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token list punctuation">-</span> cluster-config-file nodes-7001.conf #配置</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token list punctuation">-</span> cluster-node-timeout 15000</pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 注意:需要准备六份,端口、aof文件、node文件配置根据端口号要命名</span></pre></td></tr></table></figure><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 注意,如果配置了密码,需要修改</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span>  find / -name client.rb  #找到client.rb的路径</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token list punctuation">-</span> vim 文件</pre></td></tr><tr><td data-num="4"></td><td><pre>class Client</pre></td></tr><tr><td data-num="5"></td><td><pre>    DEFAULTS = &#123;</pre></td></tr><tr><td data-num="6"></td><td><pre>      :url => lambda &#123; ENV["REDIS_URL"] &#125;,</pre></td></tr><tr><td data-num="7"></td><td><pre>      :scheme => "redis",</pre></td></tr><tr><td data-num="8"></td><td><pre>      :host => "127.0.0.1",</pre></td></tr><tr><td data-num="9"></td><td><pre>      :port => 6379,</pre></td></tr><tr><td data-num="10"></td><td><pre>      :path => nil,</pre></td></tr><tr><td data-num="11"></td><td><pre>      :timeout => 5.0,</pre></td></tr><tr><td data-num="12"></td><td><pre>      :password => "密码",</pre></td></tr><tr><td data-num="13"></td><td><pre>      :db => 0,</pre></td></tr><tr><td data-num="14"></td><td><pre>      :driver => nil,</pre></td></tr><tr><td data-num="15"></td><td><pre>      :id => nil,</pre></td></tr><tr><td data-num="16"></td><td><pre>      :tcp_keepalive => 0,</pre></td></tr><tr><td data-num="17"></td><td><pre>      :reconnect_attempts => 1,</pre></td></tr><tr><td data-num="18"></td><td><pre>      :inherit_socket => false</pre></td></tr><tr><td data-num="19"></td><td><pre>    &#125;</pre></td></tr></table></figure><blockquote><p><strong>redis 集群总线</strong></p></blockquote><p>redis 集群总线端口为 redis 客户端端口加上 10000，比如说你的 redis 6379 端口为客户端通讯端口，那么 16379 端口为集群总线端口，如果主机是 7000、7001、7002, 那么需要开放 17000、17001、17002 端口，不然还是创建不了集群</p><blockquote><p>启动 Redis 服务</p></blockquote><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 启动6个Redis服务</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token list punctuation">-</span> ./redis-server redis7000.conf</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token list punctuation">-</span> ./redis-server redis7001.conf</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token list punctuation">-</span> ./redis-server redis7002.conf</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token list punctuation">-</span> ./redis-server redis7003.conf</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token list punctuation">-</span> ./redis-server redis7004.conf</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token list punctuation">-</span> ./redis-server redis7005.conf</pre></td></tr></table></figure><p>![image-20210816154359453](/Users/wyh/Library/Application Support/typora-user-images/image-20210816154359453.png)</p><blockquote><p>创建集群</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 创建集群</span></pre></td></tr><tr><td data-num="2"></td><td><pre>./redis-trib.rb  create  --replicas <span class="token number">1</span> <span class="token number">8.131</span>.234.138:7000 <span class="token number">8.131</span>.234.138:7001 <span class="token number">8.131</span>.234.138:7002 <span class="token number">8.131</span>.234.138:7003 <span class="token number">8.131</span>.234.138:7004 <span class="token number">8.131</span>.234.138:7005</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>./redis-trib.rb  create  --replicas  <span class="token number">1</span>  <span class="token comment">#创建的集群数量</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token number">8.131</span>.234.138:7000  </pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token number">8.131</span>.234.138:7001 </pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">8.131</span>.234.138:7002  <span class="token comment">#前三个为主节点，一定要开放主节点 + 10000 的端口</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token number">8.131</span>.234.138:7003  <span class="token comment">#后三个为从节点 </span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token number">8.131</span>.234.138:7004 </pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token number">8.131</span>.234.138:7005</pre></td></tr></table></figure><p><img data-src="https://tva1.sinaimg.cn/large/008i3skNgy1gtiogoco24j610b0u0alo02.jpg" alt="image-20210816154842817"></p><blockquote><p>查看集群的状态</p></blockquote><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./redis-trib.rb check localhost:7000 <span class="token comment">#随便查看一个端口就可以</span></pre></td></tr></table></figure><blockquote><p>连接集群</p></blockquote><figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 客户端方式连接集群</span></pre></td></tr><tr><td data-num="2"></td><td><pre>./redis-cli -p 7000 -c   </pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token title important"><span class="token punctuation">#</span> 注意:必须加-c 表示以集群的方式进行连接,连接任意节点都可以,在设置值的时候会根据CRC16算法进行重定向</span></pre></td></tr></table></figure><blockquote><p>springboot 操作集群</p></blockquote><p>application.properties 配置文件</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>spring<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>password<span class="token operator">=</span>密码</pre></td></tr><tr><td data-num="2"></td><td><pre>#集群操作 书写集群中所有节点</pre></td></tr><tr><td data-num="3"></td><td><pre>spring<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>nodes<span class="token operator">=</span><span class="token number">8.131</span><span class="token number">.234</span><span class="token number">.138</span><span class="token operator">:</span><span class="token number">7000</span><span class="token punctuation">,</span><span class="token number">8.131</span><span class="token number">.234</span><span class="token number">.138</span><span class="token operator">:</span><span class="token number">7001</span><span class="token punctuation">,</span><span class="token number">8.131</span><span class="token number">.234</span><span class="token number">.138</span><span class="token operator">:</span><span class="token number">7002</span><span class="token punctuation">,</span><span class="token number">8.131</span><span class="token number">.234</span><span class="token number">.138</span><span class="token operator">:</span><span class="token number">7004</span><span class="token punctuation">,</span><span class="token number">8.131</span><span class="token number">.234</span><span class="token number">.138</span><span class="token operator">:</span><span class="token number">7005</span></pre></td></tr></table></figure><div class="tags"><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="ic i-tag"></i> 分布式</a> <a href="/tags/Redis/" rel="tag"><i class="ic i-tag"></i> Redis</a> <a href="/tags/%E9%9D%9E%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"><i class="ic i-tag"></i> 非关系型数据库</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2021-10-22 20:18:58" itemprop="dateModified" datetime="2021-10-22T20:18:58+08:00">2021-10-22</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>故犹 <i class="ic i-at"><em>@</em></i>努力走,走到灯火通明</li><li class="link"><strong>本文链接：</strong> <a href="https://guyouwyh.github.io/guyouwyh/2021/10/21/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/redis/" title="Redis笔记">https://guyouwyh.github.io/guyouwyh/2021/10/21/数据库/Redis/redis/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/10/21/%E5%90%8E%E7%AB%AF/Spring%E6%A1%86%E6%9E%B6/Springboot%E7%AC%94%E8%AE%B0/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2021&#x2F;12&#x2F;15&#x2F;NdVWt9mYHDG1SFs.jpg" title="Springboot2.x笔记"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Spring框架</span><h3>Springboot2.x笔记</h3></a></div><div class="item right"><a href="/2021/10/21/%E5%90%8E%E7%AB%AF/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;s2.loli.net&#x2F;2021&#x2F;12&#x2F;15&#x2F;7E2sYl8uZARyLqh.jpg" title="ElasticSearch笔记"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 分布式中间件</span><h3>ElasticSearch笔记</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#redis%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">Redis 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis%E4%B8%8B%E8%BD%BD"><span class="toc-number">2.</span> <span class="toc-text">Redis 下载</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-%E5%91%BD%E4%BB%A4"><span class="toc-number">3.</span> <span class="toc-text">Redis 命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E5%90%AF%E5%8A%A8%E7%BB%86%E8%8A%82"><span class="toc-number">3.1.</span> <span class="toc-text">redis 启动细节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%90%AF%E5%8A%A8%E7%AB%AF%E5%8F%A3"><span class="toc-number">3.2.</span> <span class="toc-text">修改启动端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis%E4%B8%AD%E5%BA%93%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">3.3.</span> <span class="toc-text">redis 中库的概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E5%BA%93"><span class="toc-number">3.4.</span> <span class="toc-text">切换库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%85%E7%A9%BA%E5%BA%93"><span class="toc-number">3.5.</span> <span class="toc-text">清空库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">4.</span> <span class="toc-text">Redis 的基本数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%AEkey"><span class="toc-number">4.1.</span> <span class="toc-text">键 (key)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2string"><span class="toc-number">4.2.</span> <span class="toc-text">字符串 (String)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">4.3.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%88%E5%B8%8Chash"><span class="toc-number">4.4.</span> <span class="toc-text">哈希 (Hash)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%97%E8%A1%A8list"><span class="toc-number">4.5.</span> <span class="toc-text">列表 (List)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E5%90%88set"><span class="toc-number">4.6.</span> <span class="toc-text">集合 (Set)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E6%8E%92%E5%BA%8F%E9%9B%86%E5%90%88zset"><span class="toc-number">4.7.</span> <span class="toc-text">可排序集合 (ZSet)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.</span> <span class="toc-text">Redis 事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="toc-number">5.1.</span> <span class="toc-text">事务的概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.</span> <span class="toc-text">事务的基本指令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis%E4%B8%AD%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">Redis 中的持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E7%85%A7snapshot"><span class="toc-number">6.1.</span> <span class="toc-text">快照 (Snapshot)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E7%82%B9"><span class="toc-number">6.2.</span> <span class="toc-text">特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aof"><span class="toc-number">6.3.</span> <span class="toc-text">AOF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%90%AFaof%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">6.4.</span> <span class="toc-text">开启 AOF 持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%BF%BD%E5%8A%A0%E9%A2%91%E7%8E%87"><span class="toc-number">6.5.</span> <span class="toc-text">日志追加频率</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aof%E6%96%87%E4%BB%B6%E7%9A%84%E9%87%8D%E5%86%99"><span class="toc-number">6.6.</span> <span class="toc-text">AOF 文件的重写</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#aof%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">6.6.1.</span> <span class="toc-text">AOF 带来的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E9%87%8D%E5%86%99%E6%96%B9%E5%BC%8F"><span class="toc-number">6.6.2.</span> <span class="toc-text">触发重写方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%86%99%E5%8E%9F%E7%90%86"><span class="toc-number">6.6.3.</span> <span class="toc-text">重写原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%81%E4%B9%85%E5%8C%96%E6%80%BB%E7%BB%93"><span class="toc-number">6.7.</span> <span class="toc-text">持久化总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#springboot%E6%95%B4%E5%90%88redis"><span class="toc-number">7.</span> <span class="toc-text">springboot 整合 Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#opsforvalue"><span class="toc-number">7.1.</span> <span class="toc-text">opsForValue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#opsforhash"><span class="toc-number">7.2.</span> <span class="toc-text">opsForHash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#opsforlist"><span class="toc-number">7.3.</span> <span class="toc-text">opsForList</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#opsforset"><span class="toc-number">7.4.</span> <span class="toc-text">opsForSet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#opsforzset"><span class="toc-number">7.5.</span> <span class="toc-text">opsForZset</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E7%9A%84key"><span class="toc-number">7.6.</span> <span class="toc-text">获取所有的 key</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%A4%B1%E6%95%88%E6%97%B6%E9%97%B4"><span class="toc-number">7.6.1.</span> <span class="toc-text">设置失效时间</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98"><span class="toc-number">8.</span> <span class="toc-text">分布式缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">8.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98cache"><span class="toc-number">8.2.</span> <span class="toc-text">什么是缓存？(Cache)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%B8%AD%E6%95%B0%E6%8D%AE%E7%9A%84%E7%89%B9%E7%82%B9"><span class="toc-number">8.3.</span> <span class="toc-text">内存中数据的特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E8%A7%A3%E5%86%B3%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">8.4.</span> <span class="toc-text">缓存解决的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E7%BC%93%E5%AD%98%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">8.5.</span> <span class="toc-text">本地缓存和分布式缓存的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%95%B4%E5%90%88mybatis%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E7%BC%93%E5%AD%98"><span class="toc-number">8.6.</span> <span class="toc-text">通过整合 mybatis 实现分布式缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#usermapperxml%E6%96%87%E4%BB%B6"><span class="toc-number">8.7.</span> <span class="toc-text">UserMapper.xml 文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E4%BC%98%E5%8C%96%E7%AD%96%E7%95%A5"><span class="toc-number">8.8.</span> <span class="toc-text">缓存优化策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%A2%E8%AF%95%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="toc-number">8.9.</span> <span class="toc-text">面试相关概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="toc-number">8.10.</span> <span class="toc-text">什么是缓存穿透</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="toc-number">8.11.</span> <span class="toc-text">什么是缓存雪崩</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">9.</span> <span class="toc-text">主从复制</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6"><span class="toc-number">10.</span> <span class="toc-text">哨兵机制</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4"><span class="toc-number">11.</span> <span class="toc-text">集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%BB%86%E8%8A%82"><span class="toc-number">11.1.</span> <span class="toc-text">集群细节</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86"><span class="toc-number">11.2.</span> <span class="toc-text">集群原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%9A%84%E6%90%AD%E5%BB%BA"><span class="toc-number">11.3.</span> <span class="toc-text">集群的搭建</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li class="active"><a href="/2021/10/21/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/redis/" rel="bookmark" title="Redis笔记">Redis笔记</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="故犹" data-src="/images/avatar.jpg"><p class="name" itemprop="name">故犹</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">201</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">38</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">95</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2d1eW91d3lo" title="https:&#x2F;&#x2F;github.com&#x2F;guyouwyh"><i class="ic i-github"></i></span> <a href="/821403296@qq.com" title="821403296@qq.com" class="item email"><i class="ic i-envelope"></i></a></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-link"></i>友链</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-magic"></i>常用网站</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/10/21/%E5%90%8E%E7%AB%AF/Spring%E6%A1%86%E6%9E%B6/Springboot%E7%AC%94%E8%AE%B0/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2021/10/21/%E5%90%8E%E7%AB%AF/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" title="分类于 动态规划">动态规划</a></div><span><a href="/2021/10/27/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/%E4%B9%B0%E5%8D%96%E8%82%A1%E7%A5%A8%E7%9A%84%E6%9C%80%E4%BD%B3%E6%97%B6%E6%9C%BA2/" title="【力扣】122.买卖股票的最佳时机II">【力扣】122.买卖股票的最佳时机II</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" title="分类于 动态规划">动态规划</a></div><span><a href="/2022/02/26/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/P1280%20%E5%B0%BC%E5%85%8B%E7%9A%84%E4%BB%BB%E5%8A%A1/" title="【洛谷】P1280 尼克的任务">【洛谷】P1280 尼克的任务</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E4%BD%8D%E8%BF%90%E7%AE%97/" title="分类于 位运算">位运算</a></div><span><a href="/2022/03/29/%E7%AE%97%E6%B3%95/%E4%BD%8D%E8%BF%90%E7%AE%97/%E6%95%B0%E7%BB%84%E4%B8%AD%E5%8F%AA%E5%87%BA%E7%8E%B0%E4%B8%80%E6%AC%A1%E7%9A%84%E5%85%83%E7%B4%A0/" title="【牛客】数组中只出现一次的数字">【牛客】数组中只出现一次的数字</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E7%BA%BF%E6%AE%B5%E6%A0%91/" title="分类于 线段树">线段树</a></div><span><a href="/2022/02/26/%E7%AE%97%E6%B3%95/%E7%BA%BF%E6%AE%B5%E6%A0%91/XOR%E8%89%BA%E6%9C%AF/" title="P2574 XOR的艺术">P2574 XOR的艺术</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" title="分类于 数据库">数据库</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/" title="分类于 Mysql">Mysql</a></div><span><a href="/2022/04/19/%E6%95%B0%E6%8D%AE%E5%BA%93/Mysql/%E7%BB%9F%E8%AE%A1%E5%A4%8D%E6%97%A6%E7%94%A8%E6%88%B78%E6%9C%88%E7%BB%83%E9%A2%98%E6%83%85%E5%86%B5/" title="【牛客】统计复旦用户8月练题情况">【牛客】统计复旦用户8月练题情况</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E5%8D%95%E8%B0%83%E9%98%9F%E5%88%97/" title="分类于 单调队列">单调队列</a></div><span><a href="/2022/02/22/%E7%AE%97%E6%B3%95/%E5%8D%95%E8%B0%83%E9%98%9F%E5%88%97/P1638%20%E9%80%9B%E7%94%BB%E5%B1%95/" title="【洛谷】P1638 逛画展">【洛谷】P1638 逛画展</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E6%90%9C%E7%B4%A2/" title="分类于 搜索">搜索</a></div><span><a href="/2022/04/04/%E7%AE%97%E6%B3%95/%E6%90%9C%E7%B4%A2/%E5%AD%90%E9%9B%86%E9%97%AE%E9%A2%98/" title="关于求所有子集问题的一些心得">关于求所有子集问题的一些心得</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a> <i class="ic i-angle-right"></i> <a href="/categories/%E5%90%8E%E7%AB%AF/Spring%E6%A1%86%E6%9E%B6/" title="分类于 Spring框架">Spring框架</a></div><span><a href="/2021/10/21/%E5%90%8E%E7%AB%AF/Spring%E6%A1%86%E6%9E%B6/SpringMVC1/" title="SpringMCV(一)">SpringMCV(一)</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E7%BA%BF%E6%AE%B5%E6%A0%91/" title="分类于 线段树">线段树</a></div><span><a href="/2022/02/24/%E7%AE%97%E6%B3%95/%E7%BA%BF%E6%AE%B5%E6%A0%91/%E7%BA%BF%E6%AE%B5%E6%A0%91%E6%A8%A1%E6%9D%BF/" title="线段树模板">线段树模板</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E7%AE%97%E6%B3%95/" title="分类于 算法">算法</a> <i class="ic i-angle-right"></i> <a href="/categories/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" title="分类于 动态规划">动态规划</a></div><span><a href="/2022/04/06/%E7%AE%97%E6%B3%95/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/%E5%88%86%E5%89%B2%E7%AD%89%E5%92%8C%E5%AD%90%E9%9B%86/" title="【力扣】416. 分割等和子集">【力扣】416. 分割等和子集</a></span></li></ul></div></div><div class="status"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">故犹 @ GuYou</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">597k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">9:02</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/10/21/数据库/Redis/redis/",favicon:{show:"加载中",hide:"OvO"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->